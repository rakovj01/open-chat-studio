# Generated by Django 4.2.7 on 2024-02-02 13:10

from django.db import migrations, models
import django.db.models.deletion


def migrate_experiment_prompt(apps, schema_editor):
    Experiment = apps.get_model("experiments", "Experiment")
    for experiment in Experiment.objects.select_related("chatbot_prompt").all():
        experiment.prompt_text = experiment.chatbot_prompt.prompt
        experiment.input_formatter = experiment.chatbot_prompt.input_formatter
        experiment.save()


def migrate_safetylayer_prompt(apps, schema_editor):
    SafetyLayer = apps.get_model("experiments", "SafetyLayer")
    for safety_layer in SafetyLayer.objects.select_related("prompt").all():
        safety_layer.name = safety_layer.prompt.name
        safety_layer.prompt_text = safety_layer.prompt.prompt
        safety_layer.save()


class Migration(migrations.Migration):
    dependencies = [
        ("experiments", "0061_experiment_assistant_alter_experiment_tools_enabled"),
    ]

    operations = [
        migrations.AddField(
            model_name="experiment",
            name="input_formatter",
            field=models.TextField(
                blank=True,
                default="",
                help_text="Use the {input} variable somewhere to modify the user input before it reaches the bot. E.g. 'Safe or unsafe? {input}'",
            ),
        ),
        migrations.AddField(
            model_name="experiment",
            name="prompt_text",
            field=models.TextField(default="", blank=True),
        ),
        migrations.AddField(
            model_name="safetylayer",
            name="name",
            field=models.CharField(max_length=50, default=""),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="safetylayer",
            name="prompt_text",
            field=models.TextField(default=""),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="experiment",
            name="chatbot_prompt",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="experiments",
                to="experiments.prompt",
            ),
        ),
        migrations.AlterField(
            model_name="safetylayer",
            name="prompt",
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to="experiments.prompt"),
        ),
        migrations.RunPython(migrate_experiment_prompt, migrations.RunPython.noop),
        migrations.RunPython(migrate_safetylayer_prompt, migrations.RunPython.noop),
    ]
